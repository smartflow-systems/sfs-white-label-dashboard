name: SFS Security Scan

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]
  schedule:
    # Run security scan weekly on Mondays at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch: # Allow manual triggers

permissions:
  contents: read
  security-events: write
  actions: read

jobs:
  security-scan:
    name: Security Vulnerability Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        if: hashFiles('package.json') != ''
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Python
        if: hashFiles('requirements.txt') != '' || hashFiles('pyproject.toml') != ''
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # Node.js Security Scanning
      - name: Run npm audit
        if: hashFiles('package.json') != ''
        id: npm-audit
        continue-on-error: true
        run: |
          npm audit --audit-level=moderate --json > npm-audit-report.json || true
          if [ -s npm-audit-report.json ]; then
            echo "npm_audit_has_issues=true" >> $GITHUB_OUTPUT
            echo "### ðŸ” NPM Audit Report" >> $GITHUB_STEP_SUMMARY
            npm audit --audit-level=moderate >> $GITHUB_STEP_SUMMARY || true
          fi

      - name: Check npm audit results
        if: steps.npm-audit.outputs.npm_audit_has_issues == 'true'
        run: |
          echo "âš ï¸  Security vulnerabilities found. Review the report above."
          echo "Run 'npm audit fix' to attempt automatic fixes."

      # Python Security Scanning
      - name: Install Python security tools
        if: hashFiles('requirements.txt') != '' || hashFiles('pyproject.toml') != ''
        run: |
          pip install safety bandit

      - name: Run safety check (Python dependencies)
        if: hashFiles('requirements.txt') != ''
        id: safety-check
        continue-on-error: true
        run: |
          echo "### ðŸ” Python Safety Check" >> $GITHUB_STEP_SUMMARY
          safety check --json > safety-report.json || true
          if [ -s safety-report.json ]; then
            safety check >> $GITHUB_STEP_SUMMARY || true
          fi

      - name: Run Bandit (Python code security)
        if: hashFiles('requirements.txt') != '' || hashFiles('pyproject.toml') != ''
        id: bandit-check
        continue-on-error: true
        run: |
          echo "### ðŸ” Bandit Security Scan" >> $GITHUB_STEP_SUMMARY
          bandit -r . -f json -o bandit-report.json || true
          if [ -s bandit-report.json ]; then
            bandit -r . >> $GITHUB_STEP_SUMMARY || true
          fi

      # Secret Scanning
      - name: Check for exposed secrets
        id: secret-scan
        continue-on-error: true
        run: |
          echo "### ðŸ” Secret Scanning" >> $GITHUB_STEP_SUMMARY

          # Check for common secret patterns
          SECRET_PATTERNS=(
            "sk_live_"
            "pk_live_"
            "whsec_"
            "-----BEGIN.*PRIVATE KEY-----"
            "AKIA[0-9A-Z]{16}"
            "ghp_[a-zA-Z0-9]{36}"
          )

          SECRETS_FOUND=0

          for pattern in "${SECRET_PATTERNS[@]}"; do
            if grep -r "$pattern" . \
              --exclude-dir=node_modules \
              --exclude-dir=.git \
              --exclude-dir=dist \
              --exclude-dir=build \
              --exclude=*.log \
              --exclude=*.json \
              > /dev/null 2>&1; then
              echo "âš ï¸  Potential secret found matching pattern: $pattern" >> $GITHUB_STEP_SUMMARY
              SECRETS_FOUND=1
            fi
          done

          if [ $SECRETS_FOUND -eq 0 ]; then
            echo "âœ… No exposed secrets detected" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Potential secrets detected - review files manually" >> $GITHUB_STEP_SUMMARY
          fi

      # Dependency Version Checks
      - name: Check for outdated dependencies (Node.js)
        if: hashFiles('package.json') != ''
        continue-on-error: true
        run: |
          echo "### ðŸ“¦ Outdated Dependencies (Node.js)" >> $GITHUB_STEP_SUMMARY
          npm outdated >> $GITHUB_STEP_SUMMARY || true

      - name: Check for outdated dependencies (Python)
        if: hashFiles('requirements.txt') != ''
        continue-on-error: true
        run: |
          echo "### ðŸ“¦ Outdated Dependencies (Python)" >> $GITHUB_STEP_SUMMARY
          pip list --outdated >> $GITHUB_STEP_SUMMARY || true

      # Generate Security Report
      - name: Generate security summary
        if: always()
        run: |
          echo "## ðŸ›¡ï¸ Security Scan Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Repository:** ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Review the detailed reports above for any issues found." >> $GITHUB_STEP_SUMMARY

      # Upload artifacts
      - name: Upload security reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-scan-reports
          path: |
            npm-audit-report.json
            safety-report.json
            bandit-report.json
          retention-days: 30
          if-no-files-found: ignore
